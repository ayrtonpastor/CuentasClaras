name: Create Release Branch
on:
  workflow_dispatch:
    inputs:
      versionName:
        description: 'Name of version  (ie 5.5.0)'
        required: true
jobs:
  createrelease:
    runs-on: ubuntu-latest
    name: createrelease and validate
    steps:
    - name: Check out code
      uses: actions/checkout@v2
    - name: Create release branch
      run: git checkout -b release/v${{ github.event.inputs.versionName }}
    - name: Initialize mandatory git config
      run: |
       git config user.name "GitHub Actions"
       git config user.email noreply@github.com
    - name: Push new branch
      run: git push origin release/v${{ github.event.inputs.versionName }}
    - name: Configuración de entorno de python
      uses: actions/setup-python@v2
      with:
          python-version: '3.7'
    - name: Instalación de librerías y dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Correr pruebas
      id: correr-pruebas
      run: python -m unittest discover -s tests
    - name: Cálculo de cubrimiento
      id: cubrimiento
      run: |
          coverage run -m unittest discover -s tests
          coverage report -m

    - name: pull-request
      id: open-pr
      uses: repo-sync/pull-request@v2
      with:
        source_branch: release/v${{ github.event.inputs.versionName }}
        destination_branch: "main"
        github_token: ${{ secrets.GITHUB_TOKEN }}
        pr_label: "auto-merge-main"
        pr_title: "v${{ github.event.inputs.versionName }} into main"
        pr_body: "Este PR fue creado ya que las pruebas en Release se ejecutaron exitosamente."
    - name: output-url
      run: echo ${{steps.open-pr.outputs.pr_url}}
    - name: output-number
      run: echo ${{steps.open-pr.outputs.pr_number}}
    - name: output-has-changed-files
      run: echo ${{steps.open-pr.outputs.has_changed_files}}
      
    - name: auto-pull-request-merge
      uses: KeisukeYamashita/auto-pull-request-merge@v1
      with:
        token: "${{ secrets.GITHUB_TOKEN }}"
        pullRequestNumber: "${{ steps.open-pr.outputs.pr_number }}"
        timeoutSeconds: 300
